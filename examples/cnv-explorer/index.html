<!DOCTYPE html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CNV Explorer</title>
<style type="text/css">
    .canvasjs-chart-credit {
    display:none;
}
</style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/higlass@1.1.2/dist/styles/hglib.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.5.4/react-dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.2/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.31.0/react-bootstrap.min.js"></script>
</head>
<body >
  <div style=" display: flex; height: 100% ">
    <div style="width: 50%">
      <h3>List of CNVs</h3>
      <div id="sv-list" style="border-right: 1px solid #aaa; margin-right: 10px">

      </div>
    </div>

    <div 
        style="width: 50%; height: 100vh; position: fixed; left: 50vw"
                     id="development-demo">
    </div>
  </div>
</body>
<script src="https://unpkg.com/higlass@1.1.2/dist/scripts/hglib.js"></script>
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
<script>

 var testViewConfig =
{
  "editable": true,
  "trackSourceServers": [
    "/api/v1",
    "http://higlass.io/api/v1"
  ],
  "exportViewUrl": "/api/v1/viewconfs",
  "views": [
    {
      "initialXDomain": [
        926576700.2500085,
        933476698.7499915
      ],
      "initialYDomain": [
        925583285.2873993,
        934470113.7126007
      ],
      "tracks": {
        "top": [
          {
            "name": "Chromosome Axis",
            "created": "2017-06-06T17:03:01.273116Z",
            "server": "http://higlass.io/api/v1",
            "tilesetUid": "N12wVGG9SPiTkk03yUayUw",
            "uid": "A2aX1mNdTLibPpWgkeyfHA",
            "type": "horizontal-chromosome-labels",
            "options": {
              "showMousePosition": false,
              "mousePositionColor": "#999999"
            },
            "width": 448,
            "height": 30,
            "position": "top"
          },
          {
            "type": "bedlike",
            "uid": "EOSvKEj9S8umnqLw98SkGw",
            "tilesetUid": "BEsUz92nQWWmXbzzNUlPWg",
            "server": "http://resgen.io/api/v1",
            "options": {
              "fillColor": "blue",
              "axisPositionHorizontal": "right",
              "labelColor": "black",
              "labelPosition": "hidden",
              "trackBorderWidth": 0,
              "trackBorderColor": "black",
              "valueColumn": 4,
              "name": "8c4ebff2-8318-4046-98f5-da8f6b1a9e3b.consensus.20170119.somatic.cna.annotated.txt.beddb"
            },
            "name": "8c4ebff2-8318-4046-98f5-da8f6b1a9e3b.consensus.20170119.somatic.cna.annotated.txt.beddb",
            "width": 448,
            "height": 55,
            "position": "top",
            "header": "chromosome\tstart\tend\ttotal_cn\tmajor_cn\tminor_cn\tstar\tlevel\tmethods_agree\tabsolute_broad_major_cn\tabsolute_broad_minor_cn\tabsolute_broad_het_error\tabsolute_broad_cov_error\taceseq_copy_number\taceseq_minor_cn\taceseq_major_cn\tbattenberg_nMaj1_A\tbattenberg_nMin1_A\tbattenberg_frac1_A\tbattenberg_nMaj2_A\tbattenberg_nMin2_A\tbattenberg_frac2_A\tbattenberg_SDfrac_A\tbattenberg_SDfrac_A_BS\tbattenberg_frac1_A_0.025\tbattenberg_frac1_A_0.975\tclonehd_copy_number\tclonehd_minor_cn\tclonehd_major_cn\tsclust_nMaj1_A\tsclust_nMin1_A\tsclust_frac1_A\tsclust_nMaj2_A\tsclust_nMin2_A\tsclust_frac2_A\tjabba_copy_number\tjabba_minor_cn\tjabba_major_cn"
          },
          {
            "name": "Gene Annotations (hg19)",
            "created": "2017-02-05T19:31:52.412319Z",
            "server": "http://higlass.io/api/v1",
            "tilesetUid": "OHJakQICQD6gTD7skx4EWA",
            "uid": "Spy23uSeQVKNXBAU-7VGxw",
            "type": "horizontal-gene-annotations",
            "options": {
              "labelColor": "black",
              "labelPosition": "hidden",
              "plusStrandColor": "blue",
              "minusStrandColor": "red",
              "trackBorderWidth": 0,
              "trackBorderColor": "black",
              "showMousePosition": false,
              "mousePositionColor": "#999999",
              "name": "Gene Annotations (hg19)"
            },
            "width": 448,
            "height": 55,
            "position": "top",
            "header": ""
          },
          {
            "name": "wgEncodeSydhTfbsGm12878Ctcfsc15914c20StdSig",
            "created": "2017-02-03T17:46:58.349271Z",
            "server": "http://higlass.io/api/v1",
            "tilesetUid": "b6qFe7fOSnaX-YkP2kzN1w",
            "uid": "XdF5dtorRqivCe5CaGSMqg",
            "type": "horizontal-bar",
            "options": {
              "labelColor": "black",
              "labelPosition": "topLeft",
              "axisPositionHorizontal": "right",
              "lineStrokeColor": "blue",
              "lineStrokeWidth": 1,
              "valueScaling": "linear",
              "trackBorderWidth": 0,
              "trackBorderColor": "black",
              "labelTextOpacity": 0.4,
              "showMousePosition": false,
              "mousePositionColor": "#999999",
              "showTooltip": false,
              "name": "CTCF binding"
            },
            "width": 448,
            "height": 35,
            "position": "top"
          }
        ],
        "left": [],
        "center": [],
        "bottom": [],
        "right": [],
        "whole": [],
        "gallery": []
      },
      "layout": {
        "w": 12,
        "h": 6,
        "x": 0,
        "y": 2,
        "i": "view1",
        "moved": false,
        "static": false
      },
      "uid": "view1"
    },
    {
      "initialXDomain": [
        23076923.076922886,
        2976923076.9230766
      ],
      "tracks": {
        "top": [
          {
            "type": "combined",
            "uid": "Bg5p9qSQT9GqnTTZVfGu1g",
            "height": 30,
            "width": 440,
            "contents": [
              {
                "name": "Chromosome Axis",
                "created": "2017-06-06T17:03:01.273116Z",
                "server": "http://higlass.io/api/v1",
                "tilesetUid": "N12wVGG9SPiTkk03yUayUw",
                "uid": "A2aX1mNdTLibPpWgkeyfHA",
                "type": "horizontal-chromosome-labels",
                "options": {
                  "showMousePosition": false,
                  "mousePositionColor": "#999999"
                },
                "width": 440,
                "height": 30,
                "position": "top"
              },
              {
                "uid": "Kc1QiOjdRYiS_dc4o8GHLA",
                "type": "viewport-projection-horizontal",
                "fromViewUid": "view1",
                "options": {
                  "projectionFillColor": "#777",
                  "projectionStrokeColor": "#777",
                  "projectionFillOpacity": 0.3,
                  "projectionStrokeOpacity": 0.7,
                  "strokeWidth": 1
                },
                "name": "Viewport Projection",
                "position": "top"
              }
            ],
            "position": "top",
            "options": {}
          },
          {
            "type": "combined",
            "uid": "cYr54iJBRr-XTeXUosnujw",
            "height": 55,
            "width": 440,
            "contents": [
              {
                "name": "Gene Annotations (hg19)",
                "created": "2017-02-05T19:31:52.412319Z",
                "server": "http://higlass.io/api/v1",
                "tilesetUid": "OHJakQICQD6gTD7skx4EWA",
                "uid": "Spy23uSeQVKNXBAU-7VGxw",
                "type": "horizontal-gene-annotations",
                "options": {
                  "labelColor": "black",
                  "labelPosition": "hidden",
                  "plusStrandColor": "blue",
                  "minusStrandColor": "red",
                  "trackBorderWidth": 0,
                  "trackBorderColor": "black",
                  "showMousePosition": false,
                  "mousePositionColor": "#999999",
                  "name": "Gene Annotations (hg19)"
                },
                "width": 440,
                "height": 55,
                "position": "top",
                "header": ""
              },
              {
                "uid": "Tbna8qOZTFyfsbDdOSIiPw",
                "type": "viewport-projection-horizontal",
                "fromViewUid": "view1",
                "options": {
                  "projectionFillColor": "#777",
                  "projectionStrokeColor": "#777",
                  "projectionFillOpacity": 0.3,
                  "projectionStrokeOpacity": 0.7,
                  "strokeWidth": 1
                },
                "name": "Viewport Projection",
                "position": "top"
              }
            ],
            "position": "top",
            "options": {}
          },
          {
            'type': 'overlay-track',
            'uid': 'overlay'
          }
        ],
        "left": [],
        "center": [],
        "bottom": [],
        "right": [],
        "whole": [],
        "gallery": []
      },
      "layout": {
        "w": 12,
        "h": 2,
        "x": 0,
        "y": 0,
        "i": "UX2CyVx9S6y_KPXNefKROw",
        "moved": false,
        "static": false
      },
      "uid": "UX2CyVx9S6y_KPXNefKROw",
      "initialYDomain": [
        1068131868.1318682,
        1931868131.868132
      ]
    }
  ],
  "zoomLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  },
  "locationLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  },
  "valueScaleLocks": {
    "locksByViewUid": {},
    "locksDict": {}
  }
}

    window.higlassApi;

    hglib.createHgComponent(
        document.getElementById('development-demo'),
        testViewConfig,
        { bounded: true },
        function (api) {
            window.hgApi = api;
        }
    );

hglib.ChromosomeInfo("//s3.amazonaws.com/pkerp/public/b37_chromInfo.txt", function(chromInfo) {
    console.log('chromInfo:', chromInfo);
  d3.tsv('8c4ebff2-8318-4046-98f5-da8f6b1a9e3b.consensus.20170119.somatic.cna.annotated.txt', function(error, data)  {
    data = data.filter(d => d.total_cn < 2 || d.total_cn > 3)
    var divs = d3.select('#sv-list')
      .selectAll('div')
      .data(data.slice(0,20))
      .enter()
      .append('a')
      .style('cursor', 'pointer')
      .on('click', function(d) {
          console.log('d:', d);
        var absStart = chromInfo.chrPositions[d.chromosome].pos + +d.start;
        var absEnd = chromInfo.chrPositions[d.chromosome].pos + +d.end;
        var padding = (absEnd - absStart) / 4

        console.log('click absStart:', absStart, absEnd);

          console.log('goto');
        window.hgApi.zoomTo(testViewConfig.views[0].uid, 
          absStart - padding, absEnd + padding,
          absStart - padding, absEnd + padding,
          1000);
      })
      .each(function(d) {
        console.log('draw overlay', d);
        
        // TODO: Draw overlay?
      })
      .append('div')
      .style("display", "flex")
      .style("justify-content", "space-around")

    var svs = divs
      .append('div')
      .style("width", "200px")
      .style("align-items", "center")




    var deletions = svs.filter(d => d.total_cn < 2)
      .append('p')
      .append('b')
      .text('Deletion')

    var amplifications = svs.filter(d => d.total_cn > 2)
      .append('p')
      .append('b')
      .text(d => `Amplification`)

   var amplifications = svs.filter(d => d.total_cn > 2)
      .append('p')
      .text(d => `(total: ${d.total_cn}, major: ${d.major_cn}, minor: ${d.minor_cn})`)

    var chroms = svs.append('p')
      .append('small')
      .text(function(d) {
        return "chr" + d.chromosome + " " + d.start + " " + d.end + " " + d.total_cn; 
      })

    // create a template viewconfig
    // replace the initial x and y domains with this item's
    // position
    var hgDivs = divs.append('div')
      .style('height', '100px')
      .style('width', '100px')
          .attr('id', (function(d,i) {
              return "cnv-" + i;
          }))
      .each(function(d,i) {
        var templateJson = JSON.parse(JSON.stringify(testViewConfig));
        templateJson.hideHeader = true;
        templateJson.editable = false;
        templateJson.zoomFixed = true;
        templateJson.views = templateJson.views.slice(0,1);
        templateJson.views[0].tracks.top = [
          testViewConfig.views[0].tracks.top[0],
          testViewConfig.views[0].tracks.top[1]
        ];
        templateJson.views[0].tracks.left = [];
        //templateJson.views[0].tracks.center[0].contents[0].options.colorbarPosition = 'hidden';
        //templateJson.views[0].tracks.center[0].contents[0].options.labelPosition = 'hidden';
        
        var absStart = chromInfo.chrPositions[d.chromosome].pos + +d.start;
        var absEnd = chromInfo.chrPositions[d.chromosome].pos + +d.end;
        var padding = (absEnd - absStart) / 2;
        console.log('absStart:', absStart, 'absEnd', absEnd)

        templateJson.views[0].initialXDomain = [absStart - padding, absEnd + padding];
        templateJson.views[0].initialYDomain = [absStart - padding, absEnd + padding];
        hglib.viewer(
          document.getElementById('cnv-' + i),
          templateJson,
          { bounded: true, renderer: 'canvas' }
        );
      });

      window.hgApi.on('location', function(data) {
        // console.log('data.xDomain:', data.xDomain);

        const fromX = data.xDomain[0];
        const toX = data.xDomain[1];

        svs.style('background', 'transparent');

        const visibleSvs = svs.filter(function(d) {
          const x1 = chromInfo.chrPositions[d.chromosome].pos + +d.start;
          const x2 = chromInfo.chrPositions[d.chromosome].pos + +d.end;

          if (fromX < x1 && x2 < toX) {
            return true;
          }
  
          return false;
        });

        visibleSvs.style('background', 'yellow');

        // console.log('data:', data);
      }, 'view1');
    ;
  });
});



</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77756807-1', 'auto');
    ga('send', 'pageview');

</script>
</html>
